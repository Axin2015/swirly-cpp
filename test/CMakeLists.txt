INCLUDE(AddFileDependencies)

INCLUDE_DIRECTORIES("${PROJECT_SOURCE_DIR}/include")
INCLUDE_DIRECTORIES("${PROJECT_SOURCE_DIR}/src")
# Locate generated source.
INCLUDE_DIRECTORIES(${CMAKE_CURRENT_BINARY_DIR})

FILE(GLOB test_SOURCES "*.c")

ADD_EXECUTABLE(dbr_test ${test_SOURCES})
TARGET_LINK_LIBRARIES(dbr_test dbr_static m)

INSTALL(TARGETS dbr_test DESTINATION bin)

ADD_CUSTOM_COMMAND(
  DEPENDS ${test_SOURCES}
  COMMAND grep -h "^TEST_CASE" ${test_SOURCES} >${CMAKE_CURRENT_BINARY_DIR}/test_cases.txt
  OUTPUT ${CMAKE_CURRENT_BINARY_DIR}/test_cases.txt
)

ADD_FILE_DEPENDENCIES(test.c ${CMAKE_CURRENT_BINARY_DIR}/test_cases.txt)

MACRO(TEST_CASE name)
  ADD_TEST(${name} ${EXECUTABLE_OUTPUT_PATH}/dbr_test ${name})
ENDMACRO(TEST_CASE)

EXECUTE_PROCESS(COMMAND grep -h "^TEST_CASE" ${test_SOURCES}
  COMMAND sed "s/TEST_CASE(\\(.*\\))/\\1/"
  OUTPUT_STRIP_TRAILING_WHITESPACE
  OUTPUT_VARIABLE TEST_CASES
)

STRING(REGEX REPLACE "(\r?\n)" ";" TEST_CASES "${TEST_CASES}")

FOREACH(name ${TEST_CASES})
  MESSAGE(STATUS "TEST_CASE(${name})")
  TEST_CASE(${name})
ENDFOREACH()
